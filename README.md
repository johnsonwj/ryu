# ryu

Implements the [ryū](https://github.com/ulfjack/ryu) algorithm for formatting floating-point numbers, which is originally due to Ulf Adams. This algorithm was published under the [CC BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/legalcode) license.

The algorithm relies on pregenerated lookup tables to improve performance; these are generated by Template Haskell so that they can be included directly in the compiled binary.

## Performance

Performance is evaluated by generating a list of 1024 `Float`s (or `Double`s) and measuring the time it takes to format that list using `Text.Format.Floating.Ryu` (which uses the precompiled lookup tables) vs `Text.Format.Floating.Simple` (which uses the same algorithm without the lookup tables). These measurements are made using [criterion](http://hackage.haskell.org/package/criterion).

The results are reported in text form below (as copied from the terminal output from criterion), as well as in an [HTML report](./bench.html). Random numbers never behave the way they should, and floating-point encoding is contrary in its own way, so these were run until they gave numbers with low variance introduced by outliers. This isn't really all that necessary, since the means work out roughly the same anyway...but it makes the author feel better.

```
benchmarking ryu/float
time                 2.849 ms   (2.829 ms .. 2.868 ms)
                     1.000 R²   (0.999 R² .. 1.000 R²)
mean                 2.838 ms   (2.831 ms .. 2.845 ms)
std dev              25.78 μs   (22.62 μs .. 29.59 μs)

benchmarking ryu/double
time                 4.068 ms   (4.050 ms .. 4.082 ms)
                     1.000 R²   (1.000 R² .. 1.000 R²)
mean                 4.065 ms   (4.059 ms .. 4.069 ms)
std dev              15.06 μs   (12.17 μs .. 19.01 μs)

benchmarking simple/float
time                 4.741 ms   (4.693 ms .. 4.778 ms)
                     1.000 R²   (0.999 R² .. 1.000 R²)
mean                 4.785 ms   (4.770 ms .. 4.810 ms)
std dev              57.65 μs   (26.16 μs .. 119.2 μs)

benchmarking simple/double
time                 11.00 ms   (10.86 ms .. 11.28 ms)
                     0.999 R²   (0.997 R² .. 1.000 R²)
mean                 10.91 ms   (10.88 ms .. 11.01 ms)
std dev              129.9 μs   (11.80 μs .. 266.9 μs)
```

Using the lookup tables resulted in a 42% speedup for 32-bit floats, and a 63% speedup for 64-bit floats. These can be run locally with `stack run performance-tests -- --output bench.html`.
